name: Build and Push Docker Images

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    # éœ€è¦å†™å…¥ packages æƒé™æ‰èƒ½æŽ¨é€åˆ° GHCR
    permissions:
      contents: read
      packages: write

    env:
      REGISTRY_URL: ${{ secrets.REGISTRY_URL }}
      APP_IMAGE_NAME: oxtiger/swiftcode           # ä¸»åº”ç”¨é•œåƒå
      WECOM_WEBHOOK: ${{ secrets.WECOM_WEBHOOK }}
      # GitHub Container Registry é…ç½®
      GHCR_REGISTRY: ghcr.io

    steps:
    - name: Set GHCR image names (lowercase)
      run: |
        # Docker é•œåƒåå¿…é¡»æ˜¯å°å†™
        OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        echo "GHCR_APP_IMAGE=ghcr.io/${OWNER_LC}/swiftcode" >> $GITHUB_ENV

    - name: Debug
      run: |
        echo "URL: $REGISTRY_URL"
        echo "USER: ${{ secrets.REGISTRY_USER }}"
        echo "GHCR: $GHCR_REGISTRY"
        echo "GHCR_APP_IMAGE: $GHCR_APP_IMAGE"

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set image tag
      id: vars
      run: |
        SHORT_SHA=${GITHUB_SHA::7}
        DATE_TAG=$(date -u +%Y%m%d-%H%M)
        echo "TAG=${DATE_TAG}-${SHORT_SHA}" >> $GITHUB_ENV
        echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
        echo "DATE_TAG=$DATE_TAG" >> $GITHUB_ENV

    - name: Login to Harbor
      id: login
      run: |
        echo "${{ secrets.REGISTRY_PASS }}" | docker login $REGISTRY_URL -u ${{ secrets.REGISTRY_USER }} --password-stdin

    - name: Login to GitHub Container Registry
      id: login-ghcr
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js for Vite
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'package-lock.json'

    - name: Build Vite Frontend
      id: build-frontend
      run: |
        npm ci
        npm run build

    - name: Setup Node.js for Next.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'nextjs-landing/package-lock.json'

    - name: Build Next.js Landing Page
      id: build-nextjs
      run: |
        cd nextjs-landing
        npm ci
        npm run build

    - name: Build Vite Docker image
      id: build-vite
      run: |
        VITE_IMAGE=$REGISTRY_URL/swiftcode-vite
        GHCR_VITE_IMAGE=ghcr.io/$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')/swiftcode-vite
        # æž„å»º Vite åº”ç”¨é•œåƒ
        docker build \
          -t $VITE_IMAGE:${{ env.TAG }} \
          -t $VITE_IMAGE:latest \
          -t $GHCR_VITE_IMAGE:${{ env.TAG }} \
          -t $GHCR_VITE_IMAGE:latest \
          .
        echo "VITE_IMAGE=$VITE_IMAGE" >> $GITHUB_ENV
        echo "GHCR_VITE_IMAGE=$GHCR_VITE_IMAGE" >> $GITHUB_ENV

    - name: Build Next.js Docker image
      id: build-nextjs-docker
      run: |
        NEXTJS_IMAGE=$REGISTRY_URL/swiftcode-nextjs
        GHCR_NEXTJS_IMAGE=ghcr.io/$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')/swiftcode-nextjs
        # æž„å»º Next.js åº”ç”¨é•œåƒ
        docker build \
          -t $NEXTJS_IMAGE:${{ env.TAG }} \
          -t $NEXTJS_IMAGE:latest \
          -t $GHCR_NEXTJS_IMAGE:${{ env.TAG }} \
          -t $GHCR_NEXTJS_IMAGE:latest \
          ./nextjs-landing
        echo "NEXTJS_IMAGE=$NEXTJS_IMAGE" >> $GITHUB_ENV
        echo "GHCR_NEXTJS_IMAGE=$GHCR_NEXTJS_IMAGE" >> $GITHUB_ENV

    - name: Push Vite image to GHCR
      id: push-vite-ghcr
      run: |
        docker push $GHCR_VITE_IMAGE:${{ env.TAG }}
        docker push $GHCR_VITE_IMAGE:latest

    - name: Push Next.js image to GHCR
      id: push-nextjs-ghcr
      run: |
        docker push $GHCR_NEXTJS_IMAGE:${{ env.TAG }}
        docker push $GHCR_NEXTJS_IMAGE:latest

    # - name: Push Vite image to Harbor
    #   id: push-vite-harbor
    #   run: |
    #     docker push $VITE_IMAGE:${{ env.TAG }}
    #     docker push $VITE_IMAGE:latest

    # - name: Push Next.js image to Harbor
    #   id: push-nextjs-harbor
    #   run: |
    #     docker push $NEXTJS_IMAGE:${{ env.TAG }}
    #     docker push $NEXTJS_IMAGE:latest


    - name: Notify Success
      if: success()
      run: |
        COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
        WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

        MSG=$(cat <<EOF
        ðŸŽ‰ æž„å»ºæˆåŠŸ

        ðŸ“¦ GHCR é•œåƒ:
        â€¢ Vite åº”ç”¨: ${GHCR_VITE_IMAGE}:${{ env.TAG }}
        â€¢ Next.js åº”ç”¨: ${GHCR_NEXTJS_IMAGE}:${{ env.TAG }}

        ðŸ•’ æž„å»ºæ—¶é—´: ${{ env.DATE_TAG }}
        ðŸ”– æ ‡ç­¾: ${{ env.TAG }}
        ðŸ” Commit: ${{ env.SHORT_SHA }}
        ðŸ‘¤ æäº¤è€…: ${{ github.actor }}
        ðŸ“‹ åˆ†æ”¯: ${{ github.ref_name }}
        
        ðŸ“¥ GHCR æ‹‰å–å‘½ä»¤:
        \`\`\`
        docker pull ${GHCR_VITE_IMAGE}:${{ env.TAG }}
        docker pull ${GHCR_NEXTJS_IMAGE}:${{ env.TAG }}
        \`\`\`

        ðŸ”— é“¾æŽ¥:
        â€¢ Commit: ${COMMIT_URL}
        â€¢ Workflow: ${WORKFLOW_URL}
        EOF
        )

        curl -sS -X POST "$WECOM_WEBHOOK" \
          -H "Content-Type: application/json" \
          -d "$(jq -nc --arg text "$MSG" '{msgtype:"text", text:{content:$text}}')"

    - name: Notify Failure
      if: failure()
      run: |
        COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
        WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

        # èŽ·å–å¤±è´¥çš„æ­¥éª¤ä¿¡æ¯
        FAILED_STEP="æœªçŸ¥"
        if [[ "${{ steps.login.outcome }}" == "failure" ]]; then
          FAILED_STEP="ç™»å½•Harborå¤±è´¥"
        elif [[ "${{ steps.login-ghcr.outcome }}" == "failure" ]]; then
          FAILED_STEP="ç™»å½•GHCRå¤±è´¥"
        elif [[ "${{ steps.build-frontend.outcome }}" == "failure" ]]; then
          FAILED_STEP="Viteå‰ç«¯æž„å»ºå¤±è´¥"
        elif [[ "${{ steps.build-nextjs.outcome }}" == "failure" ]]; then
          FAILED_STEP="Next.jsæž„å»ºå¤±è´¥"
        elif [[ "${{ steps.build-vite.outcome }}" == "failure" ]]; then
          FAILED_STEP="Vite Dockeré•œåƒæž„å»ºå¤±è´¥"
        elif [[ "${{ steps.build-nextjs-docker.outcome }}" == "failure" ]]; then
          FAILED_STEP="Next.js Dockeré•œåƒæž„å»ºå¤±è´¥"
        elif [[ "${{ steps.push-vite-harbor.outcome }}" == "failure" ]]; then
          FAILED_STEP="Viteé•œåƒæŽ¨é€åˆ°Harborå¤±è´¥"
        elif [[ "${{ steps.push-nextjs-harbor.outcome }}" == "failure" ]]; then
          FAILED_STEP="Next.jsé•œåƒæŽ¨é€åˆ°Harborå¤±è´¥"
        elif [[ "${{ steps.push-vite-ghcr.outcome }}" == "failure" ]]; then
          FAILED_STEP="Viteé•œåƒæŽ¨é€åˆ°GHCRå¤±è´¥"
        elif [[ "${{ steps.push-nextjs-ghcr.outcome }}" == "failure" ]]; then
          FAILED_STEP="Next.jsé•œåƒæŽ¨é€åˆ°GHCRå¤±è´¥"
        fi

        MSG=$(cat <<EOF
        âŒ æž„å»ºå¤±è´¥

        ðŸ•’ æž„å»ºæ—¶é—´: ${{ env.DATE_TAG }}
        ðŸ”– æ ‡ç­¾: ${{ env.TAG }}
        ðŸ” Commit: ${{ env.SHORT_SHA }}
        ðŸ‘¤ æäº¤è€…: ${{ github.actor }}
        ðŸ“‹ åˆ†æ”¯: ${{ github.ref_name }}
        ðŸ’¥ å¤±è´¥æ­¥éª¤: ${FAILED_STEP}

        ðŸ”— é“¾æŽ¥:
        â€¢ Commit: ${COMMIT_URL}
        â€¢ æŸ¥çœ‹è¯¦æƒ…: ${WORKFLOW_URL}

        è¯·æ£€æŸ¥æž„å»ºæ—¥å¿—å¹¶ä¿®å¤é—®é¢˜åŽé‡æ–°æäº¤ã€‚
        EOF
        )

        curl -sS -X POST "$WECOM_WEBHOOK" \
          -H "Content-Type: application/json" \
          -d "$(jq -nc --arg text "$MSG" '{msgtype:"text", text:{content:$text}}')"
