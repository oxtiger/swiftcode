name: Build and Push Docker Images

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    # éœ€è¦å†™å…¥ packages æƒé™æ‰èƒ½æŽ¨é€åˆ° GHCR
    permissions:
      contents: read
      packages: write

    env:
      REGISTRY_URL: ${{ secrets.REGISTRY_URL }}
      APP_IMAGE_NAME: oxtiger/swiftcode           # ä¸»åº”ç”¨é•œåƒå
      WECOM_WEBHOOK: ${{ secrets.WECOM_WEBHOOK }}
      # GitHub Container Registry é…ç½®
      GHCR_REGISTRY: ghcr.io

    steps:
    - name: Set GHCR image names (lowercase)
      run: |
        # Docker é•œåƒåå¿…é¡»æ˜¯å°å†™
        OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        echo "GHCR_APP_IMAGE=ghcr.io/${OWNER_LC}/swiftcode" >> $GITHUB_ENV

    - name: Debug
      run: |
        echo "URL: $REGISTRY_URL"
        echo "USER: ${{ secrets.REGISTRY_USER }}"
        echo "GHCR: $GHCR_REGISTRY"
        echo "GHCR_APP_IMAGE: $GHCR_APP_IMAGE"

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set image tag
      id: vars
      run: |
        SHORT_SHA=${GITHUB_SHA::7}
        DATE_TAG=$(date -u +%Y%m%d-%H%M)
        echo "TAG=${DATE_TAG}-${SHORT_SHA}" >> $GITHUB_ENV
        echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
        echo "DATE_TAG=$DATE_TAG" >> $GITHUB_ENV

    - name: Login to Harbor
      id: login
      run: |
        echo "${{ secrets.REGISTRY_PASS }}" | docker login $REGISTRY_URL -u ${{ secrets.REGISTRY_USER }} --password-stdin

    - name: Login to GitHub Container Registry
      id: login-ghcr
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'web/package-lock.json'

    - name: Build Frontend
      id: build-frontend
      run: |
        cd web
        npm ci
        npm run build

    - name: Build App Docker image
      id: build-app
      run: |
        FULL_IMAGE=$REGISTRY_URL/$APP_IMAGE_NAME
        # æž„å»ºå¹¶æ‰“æ ‡ç­¾ï¼ˆHarbor + GHCRï¼‰
        docker build \
          -t $FULL_IMAGE:${{ env.TAG }} \
          -t $FULL_IMAGE:latest \
          -t $GHCR_APP_IMAGE:${{ env.TAG }} \
          -t $GHCR_APP_IMAGE:latest \
          .

    - name: Push App Docker image to GHCR
      id: push-app-ghcr
      run: |
        docker push $GHCR_APP_IMAGE:${{ env.TAG }}
        docker push $GHCR_APP_IMAGE:latest

    - name: Push App Docker image to Harbor
      id: push-app
      run: |
        FULL_IMAGE=$REGISTRY_URL/$APP_IMAGE_NAME
        docker push $FULL_IMAGE:${{ env.TAG }}
        docker push $FULL_IMAGE:latest


    - name: Notify Success
      if: success()
      run: |
        APP_IMAGE=$REGISTRY_URL/${APP_IMAGE_NAME}
        APP_PULL_CMD="docker pull ${APP_IMAGE}:${{ env.TAG }}"
        GHCR_APP_PULL_CMD="docker pull ${GHCR_APP_IMAGE}:${{ env.TAG }}"
        COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
        WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

        MSG=$(cat <<EOF
        ðŸŽ‰ æž„å»ºæˆåŠŸ

        ðŸ“¦ Harbor é•œåƒ:
        â€¢ ä¸»åº”ç”¨: ${APP_IMAGE}:${{ env.TAG }}

        ðŸ“¦ GHCR é•œåƒ:
        â€¢ ä¸»åº”ç”¨: ${GHCR_APP_IMAGE}:${{ env.TAG }}

        ðŸ•’ æž„å»ºæ—¶é—´: ${{ env.DATE_TAG }}
        ðŸ”– æ ‡ç­¾: ${{ env.TAG }}
        ðŸ” Commit: ${{ env.SHORT_SHA }}
        ðŸ‘¤ æäº¤è€…: ${{ github.actor }}
        ðŸ“‹ åˆ†æ”¯: ${{ github.ref_name }}

        ðŸ“¥ Harbor æ‹‰å–å‘½ä»¤:
        \`\`\`
        ${APP_PULL_CMD}
        \`\`\`

        ðŸ“¥ GHCR æ‹‰å–å‘½ä»¤:
        \`\`\`
        ${GHCR_APP_PULL_CMD}
        \`\`\`

        ðŸ”— é“¾æŽ¥:
        â€¢ Commit: ${COMMIT_URL}
        â€¢ Workflow: ${WORKFLOW_URL}
        EOF
        )

        curl -sS -X POST "$WECOM_WEBHOOK" \
          -H "Content-Type: application/json" \
          -d "$(jq -nc --arg text "$MSG" '{msgtype:"text", text:{content:$text}}')"

    - name: Notify Failure
      if: failure()
      run: |
        APP_IMAGE=$REGISTRY_URL/${APP_IMAGE_NAME}
        COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
        WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

        # èŽ·å–å¤±è´¥çš„æ­¥éª¤ä¿¡æ¯
        FAILED_STEP="æœªçŸ¥"
        if [[ "${{ steps.login.outcome }}" == "failure" ]]; then
          FAILED_STEP="ç™»å½•Harborå¤±è´¥"
        elif [[ "${{ steps.login-ghcr.outcome }}" == "failure" ]]; then
          FAILED_STEP="ç™»å½•GHCRå¤±è´¥"
        elif [[ "${{ steps.build-frontend.outcome }}" == "failure" ]]; then
          FAILED_STEP="å‰ç«¯æž„å»ºå¤±è´¥"
        elif [[ "${{ steps.build-app.outcome }}" == "failure" ]]; then
          FAILED_STEP="ä¸»åº”ç”¨Dockeré•œåƒæž„å»ºå¤±è´¥"
        elif [[ "${{ steps.push-app.outcome }}" == "failure" ]]; then
          FAILED_STEP="ä¸»åº”ç”¨é•œåƒæŽ¨é€åˆ°Harborå¤±è´¥"
        elif [[ "${{ steps.push-app-ghcr.outcome }}" == "failure" ]]; then
          FAILED_STEP="ä¸»åº”ç”¨é•œåƒæŽ¨é€åˆ°GHCRå¤±è´¥"
        fi

        MSG=$(cat <<EOF
        âŒ æž„å»ºå¤±è´¥

        ðŸ“¦ ä¸»åº”ç”¨é•œåƒ: ${APP_IMAGE}
        ðŸ•’ æž„å»ºæ—¶é—´: ${{ env.DATE_TAG }}
        ðŸ”– æ ‡ç­¾: ${{ env.TAG }}
        ðŸ” Commit: ${{ env.SHORT_SHA }}
        ðŸ‘¤ æäº¤è€…: ${{ github.actor }}
        ðŸ“‹ åˆ†æ”¯: ${{ github.ref_name }}
        ðŸ’¥ å¤±è´¥æ­¥éª¤: ${FAILED_STEP}

        ðŸ”— é“¾æŽ¥:
        â€¢ Commit: ${COMMIT_URL}
        â€¢ æŸ¥çœ‹è¯¦æƒ…: ${WORKFLOW_URL}

        è¯·æ£€æŸ¥æž„å»ºæ—¥å¿—å¹¶ä¿®å¤é—®é¢˜åŽé‡æ–°æäº¤ã€‚
        EOF
        )

        curl -sS -X POST "$WECOM_WEBHOOK" \
          -H "Content-Type: application/json" \
          -d "$(jq -nc --arg text "$MSG" '{msgtype:"text", text:{content:$text}}')"
